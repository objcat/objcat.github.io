# ğŸ å¤§ä½¬å†™çš„ä»£ç ç”Ÿæˆè„šæœ¬

https://toxicstar.top/index.php/archives/61/

## ğŸŒ² ç¬¬ä¸€ç‰ˆ

```
using System;
using System.Collections.Generic;
using System.IO;
using UnityEditor;
using UnityEngine;
using UnityEngine.UI;
using YouYou;

namespace JiangHu.Tools
{
    public class CreateUIScriptTool
    {
        [MenuItem("Assets/ç”ŸæˆUIè„šæœ¬",false,10000)]  //æ³¨é‡Šçœ‹ä¸‹é¢Cell
        public static void CreateUIScript()
        {
            var gameObject = Selection.activeGameObject;
            if (gameObject == null)
            {
                GameEntry.LogError("è¯·é€‰ä¸­é¢„åˆ¶ä½“ï¼");
                return;
            }
            if (!gameObject.name.StartsWith("UI"))
            {
                GameEntry.LogError("è‡ªåŠ¨ç”Ÿæˆä»£ç å¿…é¡»æ˜¯ä»¥UIå¼€å¤´çš„UIé¢„åˆ¶ä½“ï¼");
                return;
            }
            string templateDesignPath = "/Game/YouYouScript/Editor/UITemplateDesign.txt";
            string templatePath = "/Game/YouYouScript/Editor/UITemplate.txt";

            string prefabPath = "Assets/Download/UI/UIPrefab";
            var directoryInfo = new DirectoryInfo(prefabPath);

            List<GameObject> needBindList = new List<GameObject>();
            foreach(var component in gameObject.GetComponentsInChildren<UIBind>())
            {
                needBindList.Add(component.gameObject);
            }

            foreach (var file in directoryInfo.GetFileSystemInfos("*", SearchOption.AllDirectories))
            {
                if (file.Extension.Equals(".prefab"))
                {
                    string name = file.Name.Substring(0, gameObject.name.Length);
                    if (name == gameObject.name)
                    {
                        string scriptDirName = file.FullName.Substring(Application.dataPath.Length + prefabPath.Length - 5);
                        scriptDirName = scriptDirName.Substring(0, scriptDirName.Length - file.Name.Length - 1);

                        string scriptPath = Application.dataPath + "/Game/YouYouScript/UI/" + scriptDirName;
                        if (!Directory.Exists(scriptPath))
                        {
                            Directory.CreateDirectory(scriptPath);
                            Debug.Log("æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸï¼");
                        }

                        string scriptStr = GetTemplateDesignText(name, needBindList, templateDesignPath);
                        using (FileStream fs = new FileStream(string.Format("{0}/{1}.Design.cs", scriptPath, name), FileMode.Create))
                        {
                            using (StreamWriter sw = new StreamWriter(fs))
                            {
                                sw.Write(scriptStr.ToString());
                                Debug.Log("ç»‘å®šå…³ç³»ç”ŸæˆæˆåŠŸï¼");
                            }
                        }

                        string scriptName = scriptPath + "/" + name + ".cs";
                        if (!File.Exists(scriptName))
                        {
                            scriptStr = GetTemplateText(name, needBindList, templatePath);
                            using (FileStream fs = new FileStream(string.Format("{0}/{1}.cs", scriptPath, name), FileMode.Create))
                            {
                                using (StreamWriter sw = new StreamWriter(fs))
                                {
                                    sw.Write(scriptStr.ToString());
                                    Debug.Log("ä¸šåŠ¡ä»£ç ç”ŸæˆæˆåŠŸï¼ä»éœ€æ‰‹åŠ¨å°†ä»£ç æ–‡ä»¶æ‹–åˆ°é¢„åˆ¶ä½“ä¸Šï¼");
                                }
                            }
                        }

                        //å›æ”¶èµ„æº
                        System.GC.Collect();
                        //åˆ·æ–°ç¼–è¾‘å™¨
                        AssetDatabase.Refresh();
                    }
                }
            }
        }

        /// <summary>
        /// ç”Ÿæˆä¸šåŠ¡ä»£ç 
        /// </summary>
        public static string GetTemplateText(string scriptName, List<GameObject> needBindList, string templatePath)
        {
            //è¯»å–æ–‡æœ¬å…¨éƒ¨å†…å®¹
            string designCode = File.ReadAllText(Application.dataPath + templatePath);

            //å¾ªç¯æ·»åŠ OnClickæ–¹æ³•æ–‡æœ¬
            string btnOnClickStr = string.Empty;
            foreach (var go in needBindList)
            {
                if (go.GetComponent<Button>() != null)
                {
                    btnOnClickStr += "        private void OnClick_" + go.name + "()\r\n        {\r\n            Log(\"ç‚¹å‡»äº†" + go.name + "\");\r\n        }\r\n";
                    continue;
                }
            }

            //æ›¿æ¢æ–‡æœ¬
            designCode = designCode.Replace("#ClassName", scriptName)
            .Replace("#BtnOnClick", btnOnClickStr)
            .Replace("#Time", DateTime.Now.ToString());

            return designCode;
        }

        /// <summary>
        /// ç”Ÿæˆç»‘å®šå…³ç³»
        /// </summary>
        public static string GetTemplateDesignText(string scriptName, List<GameObject> needBindList,string templateDesignPath)
        {
            //è¯»å–æ–‡æœ¬å…¨éƒ¨å†…å®¹
            string designCode = File.ReadAllText(Application.dataPath + templateDesignPath);

            //å¾ªç¯æ·»åŠ ç»„ä»¶åˆå§‹åŒ– ç»„ä»¶ç»‘å®š æŒ‰é’®ç»‘å®š
            string initComponentStr = string.Empty;
            string bindComponentStr = string.Empty;
            string btnOnClickStr = string.Empty;
            foreach (var go in needBindList)
            {
                var bind = go.GetComponent<UIBind>();
                var name = go.name;
                if(bind == null)
                {
                    continue;
                }
                bindComponentStr += "            " + name + " = rectTransform.Find(\"" + FindComponentInPrefabPath(scriptName, go) + "\").GetComponent<" + bind.BindComponent.GetType() + ">();\r\n";
                initComponentStr += "\r\n        /// <summary>\r\n        /// " + bind.Content + "\r\n        /// </summary>";
                initComponentStr += "\r\n        private " + bind.BindComponent.GetType() + " " + name + ";\r\n";

                if (go.GetComponent<Button>() != null)
                {
                    btnOnClickStr += "            " + name + ".onClick.AddListener(OnClick_" + name + ");\r\n";
                }
            }

            //æ›¿æ¢æ–‡æœ¬
            designCode = designCode.Replace("#ClassName", scriptName)
            .Replace("#InitComponent", initComponentStr)
            .Replace("#BindComponent", bindComponentStr)
            .Replace("#BtnAddOnClick", btnOnClickStr)
            .Replace("#Time", DateTime.Now.ToString());

            return designCode;
        }

        /// <summary>
        /// å¾ªç¯çˆ¶ç‰©ä½“æ‹¿åˆ°ç»„ä»¶è·¯å¾„
        /// </summary>
        private static string FindComponentInPrefabPath(string scriptName, GameObject go)
        {
            //æ‹¿åˆ°çˆ¶ç‰©ä½“ ä¿®æ”¹è·¯å¾„ è®¾ç½®è·³å‡ºå€¼
            var parentGo = go.transform.parent;
            string path = parentGo.name + "/" + go.name;
            bool isParent = true;

            while (isParent)
            {
                //å¦‚æœçˆ¶ç‰©ä½“åå­—ç­‰äºä¼ è¿›æ¥çš„å¯¹è±¡å å°±é€€å‡º
                if (parentGo.name == scriptName)
                {
                    isParent = false;
                    break;
                }

                //å¾ªç¯æ·»åŠ è·¯å¾„
                parentGo = parentGo.transform.parent;
                path = parentGo.name + "/" + path;
            }

            //åˆ é™¤æœ€ä¸Šçº§ç‰©ä½“å
            path = path.Substring(parentGo.name.Length + 1);

            return path;
        }

        [MenuItem("Assets/ç”ŸæˆCellè„šæœ¬", false, 10000)]
        public static void CreateCellScript()
        {
            //è·å–é€‰ä¸­ç‰©ä½“å¯¹è±¡ åˆ¤æ–­æ˜¯å¦ä¸ºCell
            var gameObject = Selection.activeGameObject;
            if (gameObject == null)
            {
                GameEntry.LogError("è¯·é€‰ä¸­é¢„åˆ¶ä½“ï¼");
                return;
            }
            if (!gameObject.name.EndsWith("Cell"))
            {
                GameEntry.LogError("è‡ªåŠ¨ç”Ÿæˆä»£ç å¿…é¡»æ˜¯ä»¥Cellç»“å°¾çš„Cellé¢„åˆ¶ä½“ï¼");
                return;
            }

            //æ¨¡æ¿è·¯å¾„
            string templateDesignPath = "/Game/YouYouScript/Editor/TemplateDesignCell.txt";
            string templatePath = "/Game/YouYouScript/Editor/TemplateCell.txt";
            //UIè·¯å¾„
            string prefabPath = "Assets/Download/UI/UIPrefab";
            var directoryInfo = new DirectoryInfo(prefabPath);

            //å¾ªç¯æ·»åŠ ç»‘å®šç»„ä»¶
            List<GameObject> needBindList = new List<GameObject>();
            foreach (var component in gameObject.GetComponentsInChildren<UIBind>())
            {
                needBindList.Add(component.gameObject);
            }

            //å¾ªç¯æ‰¾åˆ°å¯¹åº”çš„é¢„åˆ¶ä½“è·¯å¾„
            foreach (var file in directoryInfo.GetFileSystemInfos("*", SearchOption.AllDirectories))
            {
                //æ‰¾åˆ°é¢„åˆ¶ä½“
                if (file.Extension.Equals(".prefab"))
                {
                    string name = file.Name.Substring(0, gameObject.name.Length);
                    //å¦‚æœæ˜¯é€‰ä¸­çš„é¢„åˆ¶ä½“
                    if (name == gameObject.name)
                    {
                        //æ‹¿åˆ°æ–‡ä»¶å¤¹åå­—
                        string scriptDirName = file.FullName.Substring(Application.dataPath.Length + prefabPath.Length - 5);
                        scriptDirName = scriptDirName.Substring(0, scriptDirName.Length - file.Name.Length - 1);

                        //æ‹¿åˆ°æ–‡ä»¶å¤¹è·¯å¾„
                        string scriptPath = Application.dataPath + "/Game/YouYouScript/UI/" + scriptDirName;
                        //å¦‚æœæ²¡æœ‰å°±åˆ›å»º
                        if (!Directory.Exists(scriptPath))
                        {
                            Directory.CreateDirectory(scriptPath);
                            Debug.Log(scriptDirName+"æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸï¼");
                        }

                        //ç”Ÿæˆç»‘å®šå…³ç³»
                        string scriptStr = GetTemplateDesignText(name, needBindList, templateDesignPath);
                        using (FileStream fs = new FileStream(string.Format("{0}/{1}.Design.cs", scriptPath, name), FileMode.Create))
                        {
                            using (StreamWriter sw = new StreamWriter(fs))
                            {
                                sw.Write(scriptStr.ToString());
                                Debug.Log("ç»‘å®šå…³ç³»ç”ŸæˆæˆåŠŸï¼");
                            }
                        }

                        //ç”Ÿæˆä¸šåŠ¡ä»£ç 
                        string scriptName = scriptPath + "/" + name + ".cs";
                        //å¦‚æœä¸å­˜åœ¨æ‰åˆ›å»º
                        if (!File.Exists(scriptName))
                        {
                            scriptStr = GetTemplateText(name, needBindList, templatePath);
                            using (FileStream fs = new FileStream(string.Format("{0}/{1}.cs", scriptPath, name), FileMode.Create))
                            {
                                using (StreamWriter sw = new StreamWriter(fs))
                                {
                                    sw.Write(scriptStr.ToString());
                                    Debug.Log("ä¸šåŠ¡ä»£ç ç”ŸæˆæˆåŠŸï¼ä»éœ€æ‰‹åŠ¨å°†ä»£ç æ‹–åˆ°é¢„åˆ¶ä½“ä¸Šï¼");
                                }
                            }
                        }

                        //å›æ”¶èµ„æº
                        System.GC.Collect();
                        //åˆ·æ–°ç¼–è¾‘å™¨
                        AssetDatabase.Refresh();
                    }
                }
            }
        }
    }
}
```

## ğŸŒ² ç¬¬äºŒç‰ˆ

```
using System.IO;
using UnityEditor;
using UnityEngine;

namespace Framework
{
    /// <summary>
    /// UIä»£ç ç”Ÿæˆ
    /// </summary>
    public class GenerateUIScript : Editor
    {
        [MenuItem("GameObject/Generate UI", false, 10000)]
        public static void GenerateUI()
        {
            var go = Selection.activeGameObject;
            if (go == null || !go.name.Contains("UI"))
            {
                Debug.LogError(go.name + " ä¸æ˜¯UIï¼");
                return;
            }

            //å¯»æ‰¾åˆ°å½“å‰objçš„è·¯å¾„
            var directoryInfo = new DirectoryInfo(Application.dataPath);
            string prefabName = go.name + ".prefab";
            string path = string.Empty;
            foreach (var item in directoryInfo.GetFiles("*.*", SearchOption.AllDirectories))
            {
                if (item.Name == prefabName)
                {
                    //é¢„åˆ¶ä½“è·¯å¾„
                    path = item.FullName;
                    //æ›¿æ¢æˆè„šæœ¬è·¯å¾„
                    path = path.Replace("GameData\\Prefabs", "GameData\\Scripts").Substring(0, path.Length - prefabName.Length);
                    break;
                }
            }

            //åˆ›å»ºç›®å½•
            if (!Directory.Exists(path))
            {
                Directory.CreateDirectory(path);
            }
            CreateUIScript(go, path);
            CreateUIDesignScript(go, path);

            Debug.Log(go.name + "ç”Ÿæˆå®Œæ¯•ï¼");
            //å›æ”¶èµ„æº
            System.GC.Collect();
            //åˆ·æ–°ç¼–è¾‘å™¨
            AssetDatabase.Refresh();
        }

        private static void CreateUIScript(GameObject go, string path)
        {
            string temp = @"using Framework;
using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

namespace GameData
{
    public partial class #UIName : UIBase
    {
        public override void OnInit()
        {
            
        }

        public override void OnShow(params object[] args)
        {
            
        }

        public override void OnBeforDestroy()
        {
            
        }
    }
}
";

            var scripts = File.CreateText(path + go.name + ".cs");
            temp = temp.Replace("#UIName", go.name);
            scripts.Write(temp);
            scripts.Close();
        }

        private static void CreateUIDesignScript(GameObject go, string path)
        {
            string temp = @"/*********************************************
 * è‡ªåŠ¨ç”Ÿæˆä»£ç ï¼Œç¦æ­¢æ‰‹åŠ¨ä¿®æ”¹æ–‡ä»¶
 * è„šæœ¬åï¼š#UIName.Design.cs
 * ä¿®æ”¹æ—¶é—´ï¼š#Time
 *********************************************/

using Framework;
using UnityEngine;
using UnityEngine.UI;

namespace GameData
{
    public partial class #UIName : UIBase
    {#Component
        public override void OnCreate()
        {
            rectTransform = gameobject.GetComponent<RectTransform>();
            #Find
        }
    }
}
";
            string componentStr = @"
        /// <summary>
        /// #Remark
        /// </summary>
        private #Component #Name;
";
            string FindStr = "#Name = rectTransform.Find(\"#Path\").GetComponent<#Component>();";

            var componentArr = go.GetComponentsInChildren<UIBind>();
            var newComponentStr = string.Empty;
            var newFindStr = string.Empty;
            for (int i = 0; i < componentArr.Length; i++)
            {
                //å£°æ˜å˜é‡
                var tempComponentStr = componentStr.Replace("#Component", componentArr[i].Obj.GetType().ToString());
                tempComponentStr = tempComponentStr.Replace("#Name", componentArr[i].Obj.name);
                tempComponentStr = tempComponentStr.Replace("#Remark", componentArr[i].Remark);
                newComponentStr += tempComponentStr;

                //å¯»æ‰¾å¯¹è±¡
                var tempFindStr = FindStr.Replace("#Component", componentArr[i].Obj.GetType().ToString());
                tempFindStr = tempFindStr.Replace("#Name", componentArr[i].Obj.name);
                tempFindStr = tempFindStr.Replace("#Path", FindComponentInPrefabPath(go.name,componentArr[i].gameObject));
                tempFindStr += "\r\n\t\t\t";
                newFindStr += tempFindStr;
            }

            //åˆ›å»ºå¯¹è±¡
            var scripts = File.CreateText(path + go.name + ".Design.cs");
            //æ–‡æœ¬æ›¿æ¢
            temp = temp.Replace("#UIName", go.name);
            temp = temp.Replace("#Time", System.DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
            temp = temp.Replace("#Component", newComponentStr);
            temp = temp.Replace("#Find", newFindStr);
            scripts.Write(temp);
            scripts.Close();
        }

        /// <summary>
        /// å¾ªç¯çˆ¶ç‰©ä½“æ‹¿åˆ°ç»„ä»¶è·¯å¾„
        /// </summary>
        private static string FindComponentInPrefabPath(string scriptName,GameObject go)
        {
            //æ‹¿åˆ°çˆ¶ç‰©ä½“ ä¿®æ”¹è·¯å¾„ è®¾ç½®è·³å‡ºå€¼
            var parentGo = go.transform.parent;
            string path = parentGo.name + "/" + go.name;
            bool isParent = true;

            while (isParent)
            {
                //å¦‚æœçˆ¶ç‰©ä½“åå­—ç­‰äºä¼ è¿›æ¥çš„å¯¹è±¡å å°±é€€å‡º
                if (parentGo.name == scriptName)
                {
                    isParent = false;
                    break;
                }

                //å¾ªç¯æ·»åŠ è·¯å¾„
                parentGo = parentGo.transform.parent;
                path = parentGo.name + "/" + path;
            }

            //åˆ é™¤æœ€ä¸Šçº§ç‰©ä½“å
            path = path.Substring(parentGo.name.Length + 1);

            return path;
        }
    }
}
```